---
title: "Group Project 2 - Poisson model"
author: "YueXu Wang"
date: "3/18/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(ggplot2)
library(tidyr)
library(dplyr)
library(scales)
library(skimr)
library(ggplot2)
library(tidyverse)
library(lmtest)
library(MASS)
library(pscl)
animals = dataset11
```

```{r}
glimpse(animals)
```

# Poisson model
We could regard variable time_at_shelter a count response and build poisson regression model for our analysis. 


First we use scatter plot to check if there are some extreme points.
```{r}
p1<-ggplot(animals,mapping=aes(x=intake_type,y=time_at_shelter))+
  geom_point(col="#f46d43")
p2<-ggplot(animals,mapping=aes(x=chip_status,y=time_at_shelter))+
  geom_point(col="#f46d43")
p3<-ggplot(animals,mapping=aes(x=animal_type,y=time_at_shelter))+
  geom_point(col="#f46d43")

p1
p2
p3

```
From the scatter plots, we could see that for variable animal_type, there are few animals which type are LIVESTOCK & BIRD.We need to determine whether these two animal types are specific to the whole model.
Maybe we should ignore these two types and build a new datasets without these two types.

We also need to check the distribution of our outcome variable time_at_shelter.

```{r}
ggplot(data=animals,aes(x=time_at_shelter))+
  geom_histogram()
```
We could see from the histgram, almost time_at_shelter is between 0 and 10. 
How many zeros in our datasets.
```{r}
zero_set<-animals.cleaned%>%
  filter(time_at_shelter=="0")
nrow(zero_set)
```
We have 374 zeros in our model which is a vary large number so we have to consider if there exits zero-exceed in our model in later analysis.


#model with whole data
```{r}
animals.glm = glm(time_at_shelter~animal_type + intake_type + chip_status, data=animals, family=poisson(link="log"))
animals.glm%>%
  summary()
```
the animal_type variable is not significant in our model.
#model with cleaned data
```{r}
animals.cleaned = animals[animals$animal_type=="DOG"|animals$animal_type=="CAT",]
animals.glm.cleaned = glm(time_at_shelter~animal_type + intake_type + chip_status, data=animals.cleaned, family=poisson(link="log"))
animals.glm.cleaned%>%
  summary()

```
After ignoreing animal type bird and livestock, we could see that all variables are significant here, and the AIC of cleaned model is smaller than the first model which suggests we should use the cleaned datasets. And because too little data and insufficient evidence on these two animal types, we will ignore these two types here.

#check if this model has Overdispersion
For poisson model, variance should equal to mean. We build scatter plots to check this assumption.
```{r}
ggplot(animals.glm.cleaned, aes(x=log(fitted(animals.glm.cleaned)), y=log((animals.cleaned$time_at_shelter-fitted(animals.glm.cleaned))^2)))+ geom_point(col="#f46d43") +geom_abline(slope=1, intercept=0, col="#a6d96a", size=1) + ylab(expression((y-hat(mu))^2)) + xlab(expression(hat(mu)))
```
We could see that a large number of points are above the line which means these exits overdispersion.
There are several methods to deal with overdispersion.

First we use Quasi-Poisson model
#Quasi-Poisson model
```{r}
animals.glm.quasi = glm(time_at_shelter~animal_type + intake_type + chip_status, data=animals.cleaned, family=quasipoisson(link="log"))
animals.glm.quasi%>%
  summary()
drop1(animals.glm.quasi, test = "F")

```
Based on F-test, animal_type, intake_type and chip_status are all significant in our model.
Compare the deviance.
```{r}
c(animals.glm.cleaned$null.deviance, animals.glm.quasi$null.deviance)
```
The deviance of these two models are equal.

Residual plots vs. predicted
```{r}
pred <- predict(animals.glm.cleaned, type = "response")
stand.resid <- rstandard(model = animals.glm.cleaned, type = "pearson") # Standardised Pearson residuals
par(mfrow=c(1,2))
plot(x = pred, y = stand.resid, xlab = "Predicted count", ylab = "Standardised Pearson residuals",
main = "Regular likelihood", ylim = c(-5,5))
abline(h = c(-3, -2, 0, 2, 3), lty = "dotted", col = "red")

pred <- predict(animals.glm.quasi, type = "response")
stand.resid <- rstandard(model = animals.glm.quasi, type = "pearson") # Standardised Pearson residuals
plot(x = pred, y = stand.resid, xlab = "Predicted count", ylab = "Standardised Pearson residuals", main = "Quasi-likelihood", ylim = c(-5,5))
abline(h = c(-3, -2, 0, 2, 3), lty = "dotted", col = "red")
```
We can see in the plots that almost all residuals are contained within Â±3 in the quasi-Poisson model, while quite a few are outside this range for the original Poisson model.

```{r}
animals.glm.cleaned$df.null
qchisq(0.95,1655)
```


#Negative binomial
Another way to deal with the Overdispersion is use the negative binomial model
```{r}
animals.glm.nb=glm.nb(time_at_shelter~animal_type + intake_type + chip_status+month+year, data=animals.cleaned)
summary(animals.glm.nb)
```

